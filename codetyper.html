<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeTyper - Programming Typing Test</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Import Hubot Sans for common UI elements */
        @import url('https://fonts.googleapis.com/css2?family=Hubot+Sans:wght@300;400;500;600;700&display=swap');

        /* JetBrains Mono is already referenced in the original for code */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap');

        :root {
            --primary: #1e1e2e;
            --secondary: #181825;
            --text: #cdd6f4;
            --text-dim: #a6adc8;
            --accent: #afeef9;
            --accent-hover: #64e2f8;
            --error: #f38ba8;
            --correct: #a6e3a1;
            --button-bg: #313244;
            --button-hover: #45475a;
            --font-ui: 'Hubot sans', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --border-radius: 8px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--primary);
            color: var(--text);
            font-family: var(--font-ui);
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 70px;
            position: relative;
        }

        .logo {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-weight: 300;
            max-width: 500px;
            margin: 0 auto;
        }

        .settings-panel {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .settings {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }

        .setting-group {
            position: relative;
        }

        .setting-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 5px;
            display: block;
        }

        select,
        button {
            background-color: var(--button-bg);
            color: var(--text);
            border: none;
            padding: 10px 18px;
            font-family: var(--font-ui);
            font-size: 0.95rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        select {
            appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23cdd6f4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        select:hover,
        button:hover {
            background-color: var(--button-hover);
        }

        select:focus,
        button:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button#startBtn {
            background-color: var(--accent);
            color: var(--secondary);
            font-weight: 600;
            padding: 5px 12px;
        }

        button#startBtn:hover {
            background-color: var(--accent-hover);
        }

        .typing-container {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            background-color: var(--secondary);
            padding: 30px;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .typing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--button-bg);
        }

        .typing-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--accent);
        }

        .timer {
            font-family: var(--font-code);
            font-size: 1.2rem;
            color: var(--text);
        }

        .typing-content {
            font-family: var(--font-code);
            font-size: 1.2rem;
            margin-bottom: 20px;
            white-space: pre-wrap;
            user-select: none;
            line-height: 1.6;
            overflow-x: auto;
        }

        .typing-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .code-content {
            margin-left: 40px;
            overflow-x: auto;
        }

        .code-char {
            position: relative;
            margin: 0;
            padding: 0;
        }

        .active-char {
            position: relative;
        }

        .active-char::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent);
            animation: blink 1s infinite;
        }

        .correct-char {
            color: var(--correct);
        }

        .error-char {
            color: var(--error);
            text-decoration: underline;
        }

        #result {
            margin-top: 40px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #result h2 {
            margin-bottom: 15px;
            color: var(--accent);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 25px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            min-width: 150px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--accent);
            font-family: var(--font-code);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 5px;
        }

        footer {
            margin-top: auto;
            text-align: center;
            padding: 30px 0;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .restart-btn {
            background-color: var(--accent);
            color: var(--secondary);
            font-weight: 600;
            margin-top: 30px;
            padding: 12px 30px;
            font-size: 1rem;
        }

        .restart-btn:hover {
            background-color: var(--accent-hover);
        }

        .theme-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--button-bg);
            transition: var(--transition);
        }

        .theme-btn:hover {
            background-color: var(--button-hover);
        }

        @keyframes blink {
            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Syntax highlighting */
        .keyword {
            color: #f38ba8;
        }

        .function {
            color: #94e2d5;
        }

        .string {
            color: #f9e2af;
        }

        .number {
            color: #fab387;
        }

        .comment {
            color: #a6adc8;
        }

        .operator {
            color: #f38ba8;
        }

        .brackets {
            color: #cdd6f4;
        }

        /* Light theme */
        .light-theme {
            --primary: #f8f8fa;
            --secondary: #eeeef0;
            --text: #2c2e31;
            --text-dim: #68686e;
            --accent: #4124e7;
            --accent-hover: #4828d9;
            --error: #ef4444;
            --correct: #22c55e;
            --button-bg: #dfdfe3;
            --button-hover: #d1d1d6;
        }

        .light-theme .keyword {
            color: #7c3aed;
        }

        .light-theme .function {
            color: #0891b2;
        }

        .light-theme .string {
            color: #ca8a04;
        }

        .light-theme .number {
            color: #c2410c;
        }

        .light-theme .comment {
            color: #68686e;
        }

        .light-theme .operator {
            color: #7c3aed;
        }

        .light-theme .brackets {
            color: #2c2e31;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            header {
                padding-top: 50px;
            }

            .logo {
                font-size: 2.5rem;
            }

            .settings {
                flex-direction: column;
                align-items: stretch;
            }

            .typing-container {
                padding: 20px;
            }

            .typing-content {
                font-size: 1rem;
            }

            .stats {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }

            .stat-item {
                width: 100%;
                max-width: 250px;
            }
        }

        .streak-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: var(--accent);
            animation: streak-animation 1s ease-out;
            pointer-events: none;
        }

        @keyframes streak-animation {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="theme-btn" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>

        <header>
            <div class="logo">CodeTyper</div>
            <div class="subtitle">Improve your coding speed and accuracy with language-specific typing tests.</div>
        </header>

        <div class="settings-panel">
            <div class="settings">
                <div class="setting-group">
                    <label class="setting-label">Language</label>
                    <select id="languageSelect">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="csharp">C#</option>
                        <option value="cpp">C++</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label class="setting-label">Difficulty</label>
                    <select id="difficultySelect">
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label class="setting-label">Time</label>
                    <select id="timeSelect">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>60 seconds</option>
                        <option value="120">2 minutes</option>
                        <option value="300">5 minutes</option>
                    </select>
                </div>

                <button id="startBtn">Start Test</button>
            </div>
        </div>

        <div class="typing-container">
            <div class="typing-header">
                <div class="typing-title">Start typing when ready...</div>
                <div class="timer">01:00</div>
            </div>
            <div class="code-content">
                <div class="typing-content" id="typingContent"></div>
            </div>
            <input type="text" class="typing-input" id="typingInput" autofocus>
        </div>

        <div id="result">
            <h2>Test Results</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="wpmValue">0</div>
                    <div class="stat-label">WPM</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracyValue">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="charactersValue">0</div>
                    <div class="stat-label">Characters</div>
                </div>
            </div>
            <button class="restart-btn" id="restartBtn">Try Again</button>
        </div>
    </div>

    <footer>
        <p>CodeTyper - Improve your programming typing skills</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // DOM elements
            const typingContent = document.getElementById('typingContent');
            const typingInput = document.getElementById('typingInput');
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');
            const timer = document.querySelector('.timer');
            const result = document.getElementById('result');
            const wpmValue = document.getElementById('wpmValue');
            const accuracyValue = document.getElementById('accuracyValue');
            const charactersValue = document.getElementById('charactersValue');
            const typingTitle = document.querySelector('.typing-title');
            const themeToggle = document.getElementById('themeToggle');
            const languageSelect = document.getElementById('languageSelect');
            const difficultySelect = document.getElementById('difficultySelect');
            const timeSelect = document.getElementById('timeSelect');

            // Add new DOM elements for enhanced features
            const wordCountSelect = document.createElement('select');
            wordCountSelect.id = 'wordCountSelect';
            wordCountSelect.innerHTML = `
                <option value="15">15 words</option>
                <option value="30">30 words</option>
                <option value="60" selected>60 words</option>
                <option value="120">120 words</option>
            `;

            const modeSelect = document.createElement('select');
            modeSelect.id = 'modeSelect';
            modeSelect.innerHTML = `
                <option value="time">Time</option>
                <option value="words">Words</option>
                <option value="custom">Custom</option>
            `;

            // Enhanced variables
            let currentIndex = 0;
            let errors = 0;
            let timerInterval;
            let timeLeft;
            let started = false;
            let totalTyped = 0;
            let correctTyped = 0;
            let isPaused = false;
            let lastActiveTime = Date.now();
            let streakCount = 0;
            let maxStreak = 0;

            // Enhanced code snippets with all languages
            const codeSnippets = {
                javascript: {
                    easy: [
                        'function greet(name) {\n  return "Hello, " + name + "!";\n}',
                        'const sum = (a, b) => a + b;',
                        'let count = 0;\ncount++;'
                    ],
                    medium: [
                        'function fibonacci(n) {\n  if (n <= 1) return n;\n  return fibonacci(n - 1) + fibonacci(n - 2);\n}',
                        'const numbers = [1, 2, 3, 4, 5];\nconst doubled = numbers.map(n => n * 2);',
                        'class Counter {\n  constructor() {\n    this.count = 0;\n  }\n  increment() {\n    this.count++;\n  }\n}'
                    ],
                    hard: [
                        'async function fetchData() {\n  try {\n    const response = await fetch(url);\n    const data = await response.json();\n    return data;\n  } catch (error) {\n    console.error(error);\n  }\n}',
                        'const memoize = (fn) => {\n  const cache = new Map();\n  return (...args) => {\n    const key = JSON.stringify(args);\n    if (cache.has(key)) return cache.get(key);\n    const result = fn.apply(this, args);\n    cache.set(key, result);\n    return result;\n  };\n};'
                    ]
                },
                python: {
                    easy: [
                        'def greet(name):\n    return f"Hello, {name}!"',
                        'numbers = [1, 2, 3, 4, 5]\nsum(numbers)',
                        'def is_even(n):\n    return n % 2 == 0'
                    ],
                    medium: [
                        'def quick_sort(arr):\n    if len(arr) <= 1:\n        return arr\n    pivot = arr[len(arr) // 2]\n    left = [x for x in arr if x < pivot]\n    middle = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n    return quick_sort(left) + middle + quick_sort(right)',
                        'class BinaryTree:\n    def __init__(self, value):\n        self.value = value\n        self.left = None\n        self.right = None',
                        'from collections import defaultdict\n\ndef word_frequency(text):\n    words = text.lower().split()\n    return defaultdict(int, {word: words.count(word) for word in words})'
                    ],
                    hard: [
                        'async def process_data(urls):\n    async with aiohttp.ClientSession() as session:\n        tasks = [fetch_url(session, url) for url in urls]\n        return await asyncio.gather(*tasks)',
                        'class MetaSingleton(type):\n    _instances = {}\n    def __call__(cls, *args, **kwargs):\n        if cls not in cls._instances:\n            cls._instances[cls] = super().__call__(*args, **kwargs)\n        return cls._instances[cls]'
                    ]
                },
                java: {
                    easy: [
                        'public class Hello {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n    }\n}',
                        'public int sum(int a, int b) {\n    return a + b;\n}',
                        'String message = "Hello";\nSystem.out.println(message.length());'
                    ],
                    medium: [
                        'public class BubbleSort {\n    public void sort(int[] arr) {\n        for (int i = 0; i < arr.length - 1; i++)\n            for (int j = 0; j < arr.length - i - 1; j++)\n                if (arr[j] > arr[j + 1]) {\n                    int temp = arr[j];\n                    arr[j] = arr[j + 1];\n                    arr[j + 1] = temp;\n                }\n    }\n}',
                        'public class LinkedList<T> {\n    private class Node {\n        T data;\n        Node next;\n        Node(T data) {\n            this.data = data;\n        }\n    }\n}'
                    ],
                    hard: [
                        'public class ThreadSafeQueue<T> {\n    private final Queue<T> queue = new ConcurrentLinkedQueue<>();\n    private final ReentrantLock lock = new ReentrantLock();\n    \n    public void enqueue(T item) {\n        lock.lock();\n        try {\n            queue.offer(item);\n        } finally {\n            lock.unlock();\n        }\n    }\n}',
                        'public class GenericDAO<T> implements AutoCloseable {\n    private final EntityManager em;\n    private final Class<T> clazz;\n    \n    public Optional<T> findById(Long id) {\n        return Optional.ofNullable(em.find(clazz, id));\n    }\n}'
                    ]
                },
                cpp: {
                    easy: [
                        '#include <iostream>\nint main() {\n    std::cout << "Hello, World!" << std::endl;\n    return 0;\n}',
                        'int sum(int a, int b) {\n    return a + b;\n}',
                        'std::string str = "Hello";\nstr.length();'
                    ],
                    medium: [
                        'template<typename T>\nclass SmartPtr {\n    T* ptr;\npublic:\n    SmartPtr(T* p) : ptr(p) {}\n    ~SmartPtr() { delete ptr; }\n    T& operator*() { return *ptr; }\n};',
                        'void quickSort(int arr[], int low, int high) {\n    if (low < high) {\n        int pi = partition(arr, low, high);\n        quickSort(arr, low, pi - 1);\n        quickSort(arr, pi + 1, high);\n    }\n}'
                    ],
                    hard: [
                        'template<typename T>\nclass ThreadSafeQueue {\n    std::queue<T> queue;\n    mutable std::mutex mutex;\n    std::condition_variable cond;\npublic:\n    void push(T value) {\n        std::lock_guard<std::mutex> lock(mutex);\n        queue.push(std::move(value));\n        cond.notify_one();\n    }\n};',
                        'class Allocator {\n    struct Block {\n        size_t size;\n        bool used;\n        Block* next;\n    };\n    Block* head;\npublic:\n    void* allocate(size_t size);\n    void deallocate(void* ptr);\n};'
                    ]
                }
            };

            // Add new features and settings
            const settings = {
                caretStyle: 'block',      // block, underline, outline
                soundEnabled: true,       // typing sound feedback
                smoothCaret: true,        // smooth caret animation
                confidenceMode: false,    // hide errors until end
                blindMode: false,        // hide the text while typing
                quickRestart: true,      // tab to restart
                showLiveWPM: true,       // show WPM while typing
                countdownLength: 3,      // seconds before start
                minWPM: 0,              // minimum WPM to save result
                minAccuracy: 0,         // minimum accuracy to save result
                theme: 'dark'           // dark, light, custom
            };

            // Add new statistics tracking
            const statistics = {
                historicalResults: [],
                personalBests: {
                    wpm: 0,
                    accuracy: 0,
                    streak: 0
                },
                averages: {
                    wpm: 0,
                    accuracy: 0,
                    consistency: 0
                }
            };

            // Set up event listeners
            startBtn.addEventListener('click', startTest);
            restartBtn.addEventListener('click', resetTest);
            typingInput.addEventListener('input', handleTyping);
            themeToggle.addEventListener('click', toggleTheme);

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter to start/restart
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!started) startTest();
                    else resetTest();
                }
                // Escape to pause
                if (e.key === 'Escape' && started) {
                    e.preventDefault();
                    togglePause();
                }
            });

            // Initialize the typing test
            function initializeTest() {
                const language = languageSelect.value;
                const difficulty = difficultySelect.value;
                const selectedCode = getRandomSnippet(language, difficulty);
                displayCode(selectedCode);
                updateTimer(parseInt(timeSelect.value));
            }

            // Get a random snippet from the code snippets
            function getRandomSnippet(language, difficulty) {
                const snippets = codeSnippets[language]?.[difficulty] || codeSnippets.javascript.easy;
                const randomIndex = Math.floor(Math.random() * snippets.length);
                return snippets[randomIndex];
            }

            // Display code with character spans
            function displayCode(code) {
                typingContent.innerHTML = '';
                for (const char of code) {
                    const span = document.createElement('span');
                    span.classList.add('code-char');
                    if (char === ' ') {
                        span.innerHTML = '&nbsp;';
                    } else if (char === '\n') {
                        span.innerHTML = '<br>';
                    } else {
                        span.textContent = char;
                    }
                    typingContent.appendChild(span);
                }
            }

            // Enhanced start test function
            function startTest() {
                if (started) return;

                resetTest();
                typingTitle.textContent = '3';
                startBtn.disabled = true;

                // Countdown animation
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        typingTitle.textContent = countdown.toString();
                    } else {
                        clearInterval(countdownInterval);
                typingTitle.textContent = 'Go!';
                        startTypingTest();
                    }
                }, 1000);
            }

            // Separate function to start the actual test
            function startTypingTest() {
                timeLeft = parseInt(timeSelect.value);
                const firstChar = typingContent.querySelector('.code-char');
                if (firstChar) firstChar.classList.add('active-char');

                typingInput.focus();
                started = true;
                lastActiveTime = Date.now();

                timerInterval = setInterval(() => {
                    if (!isPaused) {
                    timeLeft--;
                    updateTimer(timeLeft);

                        // Check for inactivity (15 seconds)
                        if (Date.now() - lastActiveTime > 15000) {
                            endTest('Inactivity detected');
                        }

                    if (timeLeft <= 0) {
                            endTest('Time\'s up!');
                        }
                    }
                }, 1000);
            }

            // Enhanced typing handler with improved accuracy
            function handleTyping(e) {
                if (!started || isPaused) return;
                if (!started) {
                    startTest();
                    return;
                }

                lastActiveTime = Date.now();
                const inputValue = e.data;
                const codeChars = typingContent.querySelectorAll('.code-char');

                if (currentIndex < codeChars.length) {
                    const currentChar = codeChars[currentIndex];
                    const expectedChar = currentChar.textContent || ' ';

                    totalTyped++;

                    if (inputValue === expectedChar) {
                        currentChar.classList.remove('active-char');
                        currentChar.classList.add('correct-char');
                        correctTyped++;
                        streakCount++;
                        maxStreak = Math.max(maxStreak, streakCount);
                        
                        // Visual feedback for streaks
                        if (streakCount > 10) {
                            showStreakEffect(streakCount);
                        }
                    } else {
                        currentChar.classList.remove('active-char');
                        currentChar.classList.add('error-char');
                        errors++;
                        streakCount = 0;
                        
                        // Vibration feedback for errors if supported
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }

                    currentIndex++;

                    // Scroll into view if needed
                    if (currentIndex < codeChars.length) {
                        codeChars[currentIndex].classList.add('active-char');
                        ensureCharacterVisible(codeChars[currentIndex]);
                    } else {
                        endTest('Completed!');
                        return;
                    }

                    // Update live stats
                    updateLiveStats();
                }

                typingInput.value = '';
            }

            // New function to ensure the current character is visible
            function ensureCharacterVisible(element) {
                const container = document.querySelector('.code-content');
                const elementRect = element.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                if (elementRect.bottom > containerRect.bottom) {
                    container.scrollTop += elementRect.bottom - containerRect.bottom + 20;
                }
            }

            // New function to show streak effect
            function showStreakEffect(streak) {
                const effect = document.createElement('div');
                effect.className = 'streak-effect';
                effect.textContent = `${streak} STREAK!`;
                document.body.appendChild(effect);
                
                setTimeout(() => effect.remove(), 1000);
            }

            // New function to update live statistics
            function updateLiveStats() {
                const timeInMinutes = (parseInt(timeSelect.value) - timeLeft) / 60;
                if (timeInMinutes > 0) {
                    const currentWPM = Math.round(correctTyped / 5 / timeInMinutes);
                    const currentAccuracy = totalTyped > 0 ? Math.round((correctTyped / totalTyped) * 100) : 0;
                    
                    // Update live stats display
                    typingTitle.textContent = `WPM: ${currentWPM} | Accuracy: ${currentAccuracy}%`;
                }
            }

            // Enhanced end test function
            function endTest(reason = 'Completed!') {
                clearInterval(timerInterval);
                started = false;
                isPaused = false;

                const timeInMinutes = parseInt(timeSelect.value) / 60;
                const wpm = Math.round(correctTyped / 5 / timeInMinutes);
                const accuracy = totalTyped > 0 ? Math.round((correctTyped / totalTyped) * 100) : 0;
                const netWPM = Math.max(0, wpm - (errors / timeInMinutes));

                // Enhanced results display
                wpmValue.textContent = wpm;
                accuracyValue.textContent = accuracy + '%';
                charactersValue.textContent = `${correctTyped}/${totalTyped}`;

                // Add new statistics
                const statsContainer = document.querySelector('.stats');
                statsContainer.innerHTML += `
                    <div class="stat-item">
                        <div class="stat-value">${netWPM}</div>
                        <div class="stat-label">Net WPM</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${maxStreak}</div>
                        <div class="stat-label">Max Streak</div>
                    </div>
                `;

                result.style.display = 'block';
                typingTitle.textContent = reason;
                startBtn.disabled = false;

                // Save high score
                saveHighScore(wpm, accuracy, netWPM);
            }

            // New function to toggle pause
            function togglePause() {
                isPaused = !isPaused;
                typingTitle.textContent = isPaused ? 'Paused' : 'Resumed';
                if (isPaused) {
                    typingInput.blur();
                } else {
                    typingInput.focus();
                }
            }

            // New function to save high scores
            function saveHighScore(wpm, accuracy, netWPM) {
                const highScores = JSON.parse(localStorage.getItem('typeTestHighScores') || '[]');
                const newScore = {
                    date: new Date().toISOString(),
                    language: languageSelect.value,
                    difficulty: difficultySelect.value,
                    wpm,
                    accuracy,
                    netWPM
                };
                
                highScores.push(newScore);
                highScores.sort((a, b) => b.netWPM - a.netWPM);
                localStorage.setItem('typeTestHighScores', JSON.stringify(highScores.slice(0, 10)));
            }

            // Toggle theme
            function toggleTheme() {
                document.body.classList.toggle('light-theme');
                const icon = themeToggle.querySelector('i');

                if (document.body.classList.contains('light-theme')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            }

            // Reset the typing test
            function resetTest() {
                clearInterval(timerInterval);
                currentIndex = 0;
                errors = 0;
                started = false;
                totalTyped = 0;
                correctTyped = 0;
                streakCount = 0;
                maxStreak = 0;

                result.style.display = 'none';
                typingTitle.textContent = 'Start typing when ready...';
                startBtn.disabled = false;

                updateTimer(parseInt(timeSelect.value));
                initializeTest();
            }

            // Update timer display
            function updateTimer(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            // Initialize everything
            initializeTest();
            initializeEnhancedFeatures();
        });

        // Add new functions for enhanced features
        function initializeEnhancedFeatures() {
            // Add sound effects
            const sounds = {
                click: new Audio('path/to/click.mp3'),
                error: new Audio('path/to/error.mp3'),
                success: new Audio('path/to/success.mp3')
            };

            // Add caret styles
            const caretStyles = {
                block: 'background-color: var(--accent);',
                underline: 'border-bottom: 2px solid var(--accent);',
                outline: 'border: 1px solid var(--accent);'
            };

            // Add result graphs
            function drawResultGraph(ctx, data) {
                // Implementation for drawing WPM/accuracy graphs
            }

            // Add replay functionality
            function replayTest(testData) {
                // Implementation for replaying a previous test
            }
        }

        // Add keyboard shortcut handler
        function handleShortcuts(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                if (settings.quickRestart) resetTest();
            }
            // Add more shortcuts
        }

        // Add result saving and loading
        function saveResult(result) {
            statistics.historicalResults.push(result);
            updatePersonalBests(result);
            updateAverages();
            localStorage.setItem('typeTestStats', JSON.stringify(statistics));
        }

        // Add consistency calculation
        function calculateConsistency(wpmArray) {
            if (wpmArray.length < 2) return 100;
            const average = wpmArray.reduce((a, b) => a + b) / wpmArray.length;
            const variance = wpmArray.reduce((a, b) => a + Math.pow(b - average, 2), 0) / wpmArray.length;
            return Math.max(0, 100 - Math.sqrt(variance));
        }
    </script>
</body>

</html>
